<!DOCTYPE html>
<html lang="en-AU">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Student Progress Tracker — Firebase</title>
  <style>
    :root{
      --bg:#ffffff; --card:#fbfbfb; --line:#e6e6e6;
      --ink:#111827; --ink-2:#6b7280; --ink-3:#9ca3af;
      --brand:#11548C; --accent:#4CAF50; --warn:#b77800; --err:#c62828;
      --radius:16px; --shadow:0 8px 30px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    html, body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";}
    a{color:var(--brand);text-decoration:none}
    h1,h2,h3{margin:0 0 .5rem 0}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    header{position:sticky;top:0;z-index:50;background:rgba(255,255,255,.9);backdrop-filter:saturate(180%) blur(8px);border-bottom:1px solid var(--line)}
    .bar{display:flex;align-items:center;gap:12px;padding:12px 16px}
    .logo{font-weight:700;letter-spacing:.2px}
    .spacer{flex:1}
    button, select, input[type="text"], input[type="email"], input[type="password"]{
      border:1px solid var(--line);border-radius:12px;padding:10px 12px;background:#fff;color:var(--ink);
      font:inherit;outline:none;box-shadow:none
    }
    button{cursor:pointer}
    button.brand{background:var(--brand);color:#fff;border-color:var(--brand)}
    button.ghost{background:#fff;color:var(--brand);border-color:var(--brand)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    nav.tabs{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 16px 0}
    nav.tabs button{padding:10px 14px;border-radius:999px;border:1px solid var(--line);background:#fff}
    nav.tabs button.active{background:var(--brand);color:#fff;border-color:var(--brand)}
    .grid{display:grid;gap:16px}
    @media (min-width:900px){.grid-2{grid-template-columns:1fr 1fr} .grid-3{grid-template-columns:1fr 1fr 1fr}}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--line);padding:10px;text-align:left;font-size:14px}
    th{color:var(--ink-2);font-weight:600}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .muted{color:var(--ink-2)}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef6ff;color:#0a4a7a;border:1px solid #dbeafe;font-size:12px}
    .hidden{display:none !important}
    .danger{color:var(--err)}
    .ok{color:var(--accent)}
    .hr{height:1px;background:var(--line);margin:8px 0 16px}
    .list{display:flex;flex-direction:column;gap:8px;max-height:360px;overflow:auto}
    .pill{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--line);padding:10px;border-radius:12px;background:#fff}
    .checkbox{transform:scale(1.1)}
    footer{padding:24px 16px;color:var(--ink-3)}
    code.inline{background:#f3f4f6;border:1px solid #e5e7eb;border-radius:6px;padding:2px 6px}
  </style>
</head>
<body>
<header>
  <div class="bar">
    <div class="logo">📚 Student Progress Tracker</div>
    <div class="spacer"></div>
    <div id="authStatus" class="muted">Signed out</div>
    <button id="signOutBtn" class="ghost hidden">Sign out</button>
  </div>
</header>

<main class="wrap">
  <section id="authView" class="card">
    <h2>Sign in</h2>
    <p class="muted">Email &amp; password only. New here? Create an account below.</p>
    <div class="grid grid-2">
      <div class="card" style="background:#fff">
        <h3>Login</h3>
        <div class="grid">
          <input id="loginEmail" type="email" placeholder="Email" autocomplete="username email" />
          <input id="loginPass" type="password" placeholder="Password" autocomplete="current-password" />
          <button id="loginBtn" class="brand">Sign in</button>
          <button id="resetBtn" class="ghost">Reset password</button>
        </div>
      </div>
      <div class="card" style="background:#fff">
        <h3>Create account</h3>
        <div class="grid">
          <input id="regEmail" type="email" placeholder="Email" autocomplete="username email" />
          <input id="regPass" type="password" placeholder="Password (min 6 chars)" autocomplete="new-password" />
          <button id="registerBtn" class="brand">Create account</button>
        </div>
      </div>
    </div>
    <p id="authMsg" class="muted"></p>
  </section>

  <section id="appView" class="hidden">
    <nav class="tabs">
      <button data-tab="students" class="active">Students</button>
      <button data-tab="assign">Assign</button>
      <button data-tab="subjects">Subjects</button>
      <button data-tab="marking">Marking</button>
      <button data-tab="data">Data</button>
    </nav>

    <!-- Students Tab -->
    <section id="tab-students" class="tab card">
      <h2>Students</h2>
      <div class="grid grid-2">
        <div class="card" style="background:#fff">
          <h3>Add student</h3>
          <div class="row">
            <input id="studentName" type="text" placeholder="Full name" />
            <input id="studentPref" type="text" placeholder="Preferred name (optional)" />
            <button id="addStudentBtn" class="brand">Add</button>
          </div>
        </div>
        <div class="card" style="background:#fff">
          <h3>Students</h3>
          <div id="studentsList" class="list"></div>
        </div>
      </div>
    </section>

    <!-- Assign Tab -->
    <section id="tab-assign" class="tab card hidden">
      <h2>Assign students to subjects</h2>
      <div class="grid grid-2">
        <div class="card" style="background:#fff">
          <div class="row">
            <select id="assignStudentSel"></select>
            <button id="refreshAssignBtn">Refresh</button>
          </div>
          <div id="assignSubjects" class="list" style="margin-top:8px"></div>
          <div class="row" style="margin-top:8px">
            <button id="saveAssignBtn" class="brand">Save assignments</button>
          </div>
        </div>
        <div class="card" style="background:#fff">
          <h3>Tips</h3>
          <p class="muted">Pick a student, tick the subjects they're enrolled in, then save.</p>
        </div>
      </div>
    </section>

    <!-- Subjects Tab -->
    <section id="tab-subjects" class="tab card hidden">
      <div class="grid grid-2">
        <div class="card" style="background:#fff">
          <h2>Subjects</h2>
          <div class="row">
            <input id="subjectName" type="text" placeholder="New subject name" />
            <button id="addSubjectBtn" class="brand">Add</button>
            <button id="importSubjectsBtn" class="ghost">Import from Excel tabs</button>
          </div>
          <div id="subjectsList" class="list" style="margin-top:8px"></div>
        </div>
        <div class="card" style="background:#fff">
          <h2>Areas &amp; Skills</h2>
          <div class="row">
            <select id="subjectSel"></select>
            <input id="areaName" type="text" placeholder="New area of study name" />
            <button id="addAreaBtn">Add area</button>
          </div>
          <div class="hr"></div>
          <div class="row">
            <select id="areaSel"></select>
            <input id="skillName" type="text" placeholder="New key skill" />
            <button id="addSkillBtn">Add skill</button>
          </div>
          <div id="skillsList" class="list" style="margin-top:8px"></div>
        </div>
      </div>
      <details style="margin-top:12px">
        <summary><span class="badge">What gets imported?</span></summary>
        <p class="muted">This app only imports subject names (the names of each worksheet/tab): it does <strong>not</strong> read any other data from your spreadsheet.</p>
        <div id="excelPreview" class="muted"></div>
      </details>
    </section>

    <!-- Marking Tab -->
    <section id="tab-marking" class="tab card hidden">
      <h2>Marking</h2>
      <div class="row">
        <select id="mStudentSel"></select>
        <select id="mSubjectSel"></select>
        <select id="mAreaSel"></select>
      </div>
      <div id="markingTableWrap" class="card" style="background:#fff;margin-top:12px">
        <table id="markingTable">
          <thead><tr><th>Skill</th><th>Completed?</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Data Tab -->
    <section id="tab-data" class="tab card hidden">
      <h2>Data &amp; account</h2>
      <div class="row">
        <button id="exportBtn">Export JSON</button>
        <input id="importFile" type="file" accept="application/json" />
        <button id="importBtn">Import JSON</button>
        <button id="dangerWipeBtn" class="danger">Wipe all my data</button>
      </div>
      <p class="muted">All data is stored per-user in Firestore under <code class="inline">/users/&lt;uid&gt;/...</code></p>
    </section>
  </section>
</main>

<footer class="wrap">
  <div>Made for GitHub Pages. Uses Firebase Auth (email/password) and Firestore.</div>
</footer>

<script type="module">
  /* =========================
     0) Firebase setup (fill me in)
     ========================= */
  // 1) In Firebase Console -> Project settings -> General -> "Your apps"
  // 2) Add a Web app, then copy the config below.
  const firebaseConfig = {
    apiKey: "PASTE_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    // (optional but recommended if you later add Storage):
    // storageBucket: "YOUR_PROJECT.appspot.com",
    // messagingSenderId: "...",
    appId: "YOUR_WEB_APP_ID"
  };

  // SDK (modular v10). If versions change, update numbers below.
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
  import { getFirestore, doc, setDoc, getDoc, getDocs, addDoc, collection, deleteDoc, serverTimestamp, query, where, orderBy } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  /* =========================
     1) Helpers
     ========================= */
  const $ = (id) => document.getElementById(id);
  const authView = $("authView");
  const appView = $("appView");
  const authStatus = $("authStatus");
  const signOutBtn = $("signOutBtn");
  const defaultSubjectCandidates = ["Sheet1", "LIT_UNIT_1", "LIT_UNIT_2", "NUM_UNIT_1", "NUM_UNIT_2", "WRS_UNIT_1", "WRS_UNIT_2", "PDS_UNIT_1", "PDS_UNIT_2", "Consolidation"];

  // Tiny UI helpers
  function showTab(name) {
    document.querySelectorAll('nav.tabs button').forEach(b => b.classList.toggle('active', b.dataset.tab===name));
    document.querySelectorAll('.tab').forEach(s => s.classList.add('hidden'));
    $("tab-" + name).classList.remove('hidden');
  }
  document.querySelectorAll('nav.tabs button').forEach(btn => btn.addEventListener('click', () => showTab(btn.dataset.tab)));

  function toast(msg) { $("authMsg").textContent = msg; setTimeout(()=>{ $("authMsg").textContent = "" }, 4000); }
  function el(tag, attrs={}, ...kids) {
    const n = document.createElement(tag);
    for (const [k,v] of Object.entries(attrs)) {
      if (k==='class') n.className = v; else if(k==='html') n.innerHTML = v; else n.setAttribute(k,v);
    }
    kids.forEach(k=> n.appendChild(typeof k==="string" ? document.createTextNode(k) : k));
    return n;
  }
  function uidPath(uid, path) { return ['users', uid, ...path].filter(Boolean).join('/'); }

  // Auth UI
  const loginBtn = $("loginBtn"), registerBtn = $("registerBtn"), resetBtn = $("resetBtn");
  loginBtn.onclick = async () => {
    try { await signInWithEmailAndPassword(auth, $("loginEmail").value, $("loginPass").value); }
    catch(e){ toast(e.message) }
  };
  registerBtn.onclick = async () => {
    try { await createUserWithEmailAndPassword(auth, $("regEmail").value, $("regPass").value); }
    catch(e){ toast(e.message) }
  };
  resetBtn.onclick = async () => {
    try { await sendPasswordResetEmail(auth, $("loginEmail").value); toast('Reset link sent (if account exists).'); }
    catch(e){ toast(e.message) }
  };
  signOutBtn.onclick = () => signOut(auth);

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      authStatus.textContent = `Signed in as ${user.email}`;
      signOutBtn.classList.remove('hidden');
      authView.classList.add('hidden');
      appView.classList.remove('hidden');
      await boot(user);
    } else {
      authStatus.textContent = 'Signed out';
      signOutBtn.classList.add('hidden');
      authView.classList.remove('hidden');
      appView.classList.add('hidden');
    }
  });

  /* =========================
     2) Data model (Firestore)
     All docs live under /users/{uid}/...
     - students/{id}: { name, preferredName, createdAt }
     - subjects/{id}: { name, createdAt }
     - subjects/{id}/areas/{id}: { name }
     - subjects/{id}/areas/{id}/skills/{id}: { name, order }
     - students/{id}/subjects/{subjectId}: { enrolled: true }
     - progress/{studentId}/subjects/{subjectId}/skills/{skillId}: { completed: bool, updatedAt }
     ========================= */

  // collections helpers
  const col = (...p) => collection(db, ...p);
  const ref = (...p) => doc(db, ...p);

  // Cache state
  let state = { uid: null, students: [], subjects: [], areasBySubject: {}, skillsByArea: {}, enrolmentsByStudent: {} };

  async function boot(user) {
    state.uid = user.uid;
    // Render Excel preview
    $("excelPreview").textContent = 'Excel tabs detected: ' + defaultSubjectCandidates.join(', ');

    await Promise.all([loadStudents(), loadSubjects()]);
    renderStudents();
    renderAssign();
    renderSubjects();
    renderAreasAndSkills();
    renderMarkingSelectors();
  }

  /* ---------- Students ---------- */
  async function loadStudents() {
    const snap = await getDocs(col('users', state.uid, 'students'));
    state.students = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b)=> (a.name||'').localeCompare(b.name||''));
  }
  function renderStudents() {
    // list
    const list = $("studentsList"); list.innerHTML = "";
    if (!state.students.length) list.append(el('div', {class:'muted'}, 'No students yet.'));
    for (const s of state.students) {
      const row = el('div', {class:'pill'}, el('div',{}, s.name + (s.preferredName?`  · “${s.preferredName}”`:"")), el('div',{}, 
        el('button', {class:'ghost', 'data-id': s.id}, 'Delete')
      ));
      row.querySelector('button').onclick = async () => {
        if (!confirm('Delete this student?')) return;
        await deleteDoc(ref('users', state.uid, 'students', s.id));
        await loadStudents(); renderStudents(); renderAssign(); renderMarkingSelectors();
      };
      list.append(row);
    }
  }
  $("addStudentBtn").onclick = async () => {
    const name = $("studentName").value.trim();
    if (!name) return toast('Enter a student name.');
    const preferred = $("studentPref").value.trim();
    await addDoc(col('users', state.uid, 'students'), { name, preferredName: preferred||null, createdAt: serverTimestamp() });
    $("studentName").value = ''; $("studentPref").value='';
    await loadStudents(); renderStudents(); renderAssign(); renderMarkingSelectors();
  };

  /* ---------- Subjects / Areas / Skills ---------- */
  async function loadSubjects() {
    const snap = await getDocs(col('users', state.uid, 'subjects'));
    state.subjects = snap.docs.map(d=>({ id:d.id, ...d.data() })).sort((a,b)=>(a.name||'').localeCompare(b.name||''));
    // load areas + skills
    state.areasBySubject = {}; state.skillsByArea = {}
    for (const subj of state.subjects) {
      const areasSnap = await getDocs(col('users', state.uid, 'subjects', subj.id, 'areas'));
      const areas = areasSnap.docs.map(d=>({ id:d.id, ...d.data() })).sort((a,b)=>(a.name||'').localeCompare(b.name||''));
      state.areasBySubject[subj.id] = areas;
      for (const a of areas) {
        const skillsSnap = await getDocs(col('users', state.uid, 'subjects', subj.id, 'areas', a.id, 'skills'));
        const skills = skillsSnap.docs.map(d=>({ id:d.id, ...d.data() })).sort((a,b)=>(a.order??999)-(b.order??999));
        state.skillsByArea[a.id] = skills;
      }
    }
  }

  function renderSubjects() {
    // list + actions
    const list = $("subjectsList"); list.innerHTML = "";
    if (!state.subjects.length) list.append(el('div', {class:'muted'}, 'No subjects yet. Use "Import from Excel tabs" or add manually.'));
    for (const s of state.subjects) {
      const row = el('div', {class:'pill'}, el('div',{}, s.name), el('div',{}, 
        el('button', {class:'ghost', 'data-id': s.id}, 'Delete')
      ));
      row.querySelector('button').onclick = async () => {
        if (!confirm('Delete this subject (and its areas/skills)?')) return;
        // delete subcollections shallowly (simple demo: you'll manually remove nested docs if many)
        await deleteDoc(ref('users', state.uid, 'subjects', s.id));
        await loadSubjects(); renderSubjects(); renderAreasAndSkills(); renderAssign(); renderMarkingSelectors();
      };
      list.append(row);
    }
  }
  $("addSubjectBtn").onclick = async () => {
    const name = $("subjectName").value.trim();
    if (!name) return toast('Enter a subject name.');
    await addDoc(col('users', state.uid, 'subjects'), { name, createdAt: serverTimestamp() });
    $("subjectName").value = '';
    await loadSubjects(); renderSubjects(); renderAreasAndSkills(); renderAssign(); renderMarkingSelectors();
  };

  // Import from Excel tab names (baked-in)
  $("importSubjectsBtn").onclick = async () => {
    // Let user choose which to import
    const choices = defaultSubjectCandidates;
    if (!choices.length) return toast('No Excel tabs detected.');
    const picks = prompt('Import which subjects? Separate by comma.\nDefault: all\n\nDetected: ' + choices.join(', '));
    const chosen = (picks && picks.trim()) ? picks.split(',').map(s=>s.trim()).filter(Boolean) : choices;
    const existing = state.subjects.map(s=> (s.name||'').toLowerCase());
    let added=0;
    for (const name of chosen) {
      if (!existing.includes(name.toLowerCase())) {
        await addDoc(col('users', state.uid, 'subjects'), { name, createdAt: serverTimestamp() });
        added++;
      }
    }
    toast(`Imported ${added} subject(s).`);
    await loadSubjects(); renderSubjects(); renderAreasAndSkills(); renderAssign(); renderMarkingSelectors();
  };

  // Areas + skills UI
  const subjectSel = $("subjectSel"), areaSel = $("areaSel"), skillsList = $("skillsList");
  function renderAreasAndSkills() {
    // subject dropdown
    subjectSel.innerHTML = state.subjects.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
    subjectSel.dispatchEvent(new Event('change'));
  }
  subjectSel.onchange = () => {
    const sid = subjectSel.value;
    const areas = state.areasBySubject[sid] || [];
    areaSel.innerHTML = areas.map(a=>`<option value="${a.id}">${a.name}</option>`).join('');
    areaSel.dispatchEvent(new Event('change'));
  };
  areaSel.onchange = () => {
    const aid = areaSel.value;
    const skills = state.skillsByArea[aid] || [];
    renderSkillList(skills);
  };

  function renderSkillList(skills) {
    skillsList.innerHTML = "";
    if (!skills.length) return skillsList.append(el('div', {class:'muted'}, 'No skills yet. Add some.'));
    for (const sk of skills) {
      const row = el('div', {class:'pill'}, el('div',{}, (sk.order!=null?`#${sk.order} · `:"") + sk.name),
        el('div',{}, el('button', {class:'ghost', 'data-id': sk.id}, 'Delete'))
      );
      row.querySelector('button').onclick = async () => {
        if (!confirm('Delete this skill?')) return;
        await deleteDoc(ref('users', state.uid, 'subjects', subjectSel.value, 'areas', areaSel.value, 'skills', sk.id));
        await loadSubjects(); renderAreasAndSkills();
      };
      skillsList.append(row);
    }
  }

  $("addAreaBtn").onclick = async () => {
    const sid = subjectSel.value;
    const name = $("areaName").value.trim();
    if (!sid || !name) return toast('Pick a subject and enter an area name.');
    await addDoc(col('users', state.uid, 'subjects', sid, 'areas'), { name });
    $("areaName").value='';
    await loadSubjects(); renderAreasAndSkills();
  };

  $("addSkillBtn").onclick = async () => {
    const sid = subjectSel.value, aid = areaSel.value;
    const name = $("skillName").value.trim();
    if (!sid || !aid || !name) return toast('Pick an area and enter a skill.');
    const order = (state.skillsByArea[aid]?.length || 0) + 1;
    await addDoc(col('users', state.uid, 'subjects', sid, 'areas', aid, 'skills'), { name, order });
    $("skillName").value='';
    await loadSubjects(); renderAreasAndSkills();
  };

  /* ---------- Assign ---------- */
  const assignStudentSel = $("assignStudentSel");
  function renderAssign() {
    // student dropdown
    assignStudentSel.innerHTML = state.students.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
    assignStudentSel.dispatchEvent(new Event('change'));
  }
  $("refreshAssignBtn").onclick = async () => { await loadEnrolments(assignStudentSel.value); renderAssignSubjects(assignStudentSel.value); };
  assignStudentSel.onchange = async () => { await loadEnrolments(assignStudentSel.value); renderAssignSubjects(assignStudentSel.value); };

  async function loadEnrolments(studentId) {
    if (!studentId) return;
    const snap = await getDocs(col('users', state.uid, 'students', studentId, 'subjects'));
    const enrols = new Set(snap.docs.map(d=>d.id));
    state.enrolmentsByStudent[studentId] = enrols;
  }
  function renderAssignSubjects(studentId) {
    const box = $("assignSubjects"); box.innerHTML="";
    const enrols = state.enrolmentsByStudent[studentId] || new Set();
    for (const subj of state.subjects) {
      const row = el('label', {class:'pill'}, 
        el('div',{}, subj.name),
        el('input', {type:'checkbox', class:'checkbox', 'data-id': subj.id, checked: enrols.has(subj.id) ? '' : undefined})
      );
      box.append(row);
    }
  }
  $("saveAssignBtn").onclick = async () => {
    const studentId = assignStudentSel.value;
    if (!studentId) return;
    const checks = Array.from(document.querySelectorAll('#assignSubjects input[type="checkbox"]'));
    const selected = checks.filter(c=>c.checked).map(c=>c.getAttribute('data-id'));
    // wipe + set
    // First read current enrols
    const existing = state.enrolmentsByStudent[studentId] || new Set();
    // Remove unchecked
    for (const sid of Array.from(existing)) {
      if (!selected.includes(sid)) await deleteDoc(ref('users', state.uid, 'students', studentId, 'subjects', sid));
    }
    // Add selected
    for (const sid of selected) {
      await setDoc(ref('users', state.uid, 'students', studentId, 'subjects', sid), { enrolled: true, updatedAt: serverTimestamp() });
    }
    await loadEnrolments(studentId);
    toast('Saved.');
    renderAssignSubjects(studentId);
  };

  /* ---------- Marking ---------- */
  const mStudentSel = $("mStudentSel"), mSubjectSel = $("mSubjectSel"), mAreaSel = $("mAreaSel");
  function renderMarkingSelectors() {
    // Student dropdown
    mStudentSel.innerHTML = state.students.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
    mStudentSel.dispatchEvent(new Event('change'));
  }
  mStudentSel.onchange = async () => {
    const sid = mStudentSel.value;
    await loadEnrolments(sid);
    const enrols = state.enrolmentsByStudent[sid] || new Set();
    const subjects = state.subjects.filter(s=> enrols.has(s.id));
    mSubjectSel.innerHTML = subjects.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
    mSubjectSel.dispatchEvent(new Event('change'));
  };
  mSubjectSel.onchange = () => {
    const subjId = mSubjectSel.value;
    const areas = state.areasBySubject[subjId] || [];
    mAreaSel.innerHTML = areas.map(a=>`<option value="${a.id}">${a.name}</option>`).join('');
    mAreaSel.dispatchEvent(new Event('change'));
  };
  mAreaSel.onchange = async () => {
    await renderMarkingTable();
  };

  async function renderMarkingTable() {
    const studentId = mStudentSel.value;
    const subjectId = mSubjectSel.value;
    const areaId = mAreaSel.value;
    const tbody = document.querySelector('#markingTable tbody');
    tbody.innerHTML = "";
    const skills = state.skillsByArea[areaId] || [];
    if (!skills.length) return tbody.append(el('tr',{}, el('td',{colspan:'2'}, 'No skills for this area.')));

    // Read progress for this student + subject
    // We'll read each skill doc (could be batched in your own app)
    const rows = [];
    for (const sk of skills) {
      const pRef = ref('users', state.uid, 'progress', studentId, 'subjects', subjectId, 'skills', sk.id);
      const snap = await getDoc(pRef);
      const completed = !!(snap.exists() && snap.data().completed);
      const tr = el('tr',{}, el('td',{}, sk.name), el('td',{}, (()=>{ 
        const cb = el('input', {type:'checkbox', class:'checkbox'});
        cb.checked = completed;
        cb.onchange = async () => {
          await setDoc(pRef, { completed: cb.checked, updatedAt: serverTimestamp() }, { merge: true });
        };
        return cb;
      })()));
      rows.push(tr);
    }
    rows.forEach(r=> tbody.append(r));
  }

  /* ---------- Data tab ---------- */
  $("exportBtn").onclick = async () => {
    const dump = { students: state.students, subjects: state.subjects, areasBySubject: state.areasBySubject, skillsByArea: state.skillsByArea };
    const blob = new Blob([JSON.stringify(dump,null,2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'progress-export.json';
    a.click();
  };
  $("importBtn").onclick = async () => {
    const f = $("importFile").files[0]; if(!f) return toast('Pick a JSON file first.');
    const text = await f.text(); const data = JSON.parse(text);
    // Only import subjects/areas/skills (not students) to avoid collisions
    if (Array.isArray(data.subjects)) {
      for (const s of data.subjects) {
        const ds = await addDoc(col('users', state.uid, 'subjects'), { name: s.name||'Imported', createdAt: serverTimestamp() });
        const sid = ds.id;
        const areas = (data.areasBySubject?.[s.id] || []);
        for (const a of areas) {
          const da = await addDoc(col('users', state.uid, 'subjects', sid, 'areas'), { name: a.name||'Area' });
          const aid = da.id;
          const skills = (data.skillsByArea?.[a.id] || []);
          for (const sk of skills) {
            await addDoc(col('users', state.uid, 'subjects', sid, 'areas', aid, 'skills'), { name: sk.name||'Skill', order: sk.order??null });
          }
        }
      }
      await loadSubjects(); renderSubjects(); renderAreasAndSkills(); renderMarkingSelectors();
      toast('Imported.');
    } else {
      toast('JSON not recognised.');
    }
  };

  $("dangerWipeBtn").onclick = async () => {
    if (!confirm('This will delete all your data under /users/uid. Proceed?')) return;
    // NOTE: Firestore deletes need to recurse; here we only delete top-level docs. For a full wipe use a Cloud Function or manual cleanup.
    const colls = ['students','subjects','progress'];
    for (const c of colls) {
      const snap = await getDocs(col('users', state.uid, c));
      for (const d of snap.docs) await deleteDoc(d.ref);
    }
    state = { uid: state.uid, students: [], subjects: [], areasBySubject: {}, skillsByArea: {}, enrolmentsByStudent: {} };
    renderStudents(); renderAssign(); renderSubjects(); renderAreasAndSkills(); renderMarkingSelectors();
    toast('Top-level docs deleted. Nested data may remain.');
  };

</script>
</body>
</html>
