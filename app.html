<!DOCTYPE html>
<html lang="en-AU">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>trackME</title>
  <style>
  /* === trackME teal minimalist theme === */
  :root{
    --bg:#f7f8fa;
    --surface:#ffffff;
    --ink:#222222;
    --muted:#5b6472;
    --line:#e6e9ee;
    --accent:#009688;    /* teal */
    --accent-2:#00796b;  /* darker teal */
    --accent-light:#4db6ac;
    --danger:#e11d48;
    --radius:16px;
    --shadow:0 10px 30px rgba(0,0,0,.06);
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);
    font-family: Georgia, 'Times New Roman', serif;
    -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
  a{color:var(--accent);text-decoration:none}
  .wrap{width:100%;max-width:min(1600px,96vw);margin:0 auto;
    padding:clamp(10px,2.2vw,24px) clamp(8px,2vw,20px)}
  .card{background:var(--surface);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
  header{position:sticky;top:0;z-index:20;background:rgba(255,255,255,.75);
    backdrop-filter:saturate(140%) blur(10px);border-bottom:1px solid var(--line)}
  .bar{display:flex;align-items:center;gap:14px;padding:12px 16px}
  .brand{display:flex;align-items:center;gap:12px;font-weight:700;font-size:18px}
  .brand .dot{width:10px;height:10px;border-radius:50%;background:var(--accent);box-shadow:0 0 0 8px rgba(0,150,136,.18)}
  .brand small{font-weight:600;color:var(--muted);font-size:12px}
  .spacer{flex:1}
  .btn,select,input[type="text"],input[type="email"],input[type="password"]{
    border:1px solid var(--line);border-radius:12px;padding:12px 14px;background:#fff;color:var(--ink);
    font:inherit;outline:none;transition:box-shadow .2s ease, transform .15s ease, background-color .2s ease}
  .btn{cursor:pointer}
  .btn.primary{background:linear-gradient(180deg,var(--accent),var(--accent-2));border-color:transparent;color:#fff}
  .btn.primary:hover{transform:translateY(-1px)}
  .btn.ghost{background:#fff;color:var(--ink)}
  .btn.ghost:hover{background:#f2f4f7}
  select:hover,input:hover{background:#f9fafb}
  select:focus,input:focus{box-shadow:0 0 0 3px rgba(0,150,136,.22);border-color:var(--accent)}
  nav.tabs{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 16px}
  nav.tabs button{padding:10px 14px;border-radius:999px;border:1px solid var(--line);background:#fff;color:var(--ink)}
  nav.tabs button.active{background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#fff;border-color:transparent}
  h1{font-size:24px;margin:4px 0 8px;color:var(--accent)}
  h2{font-size:18px;margin:0 0 8px;color:var(--accent)}
  h3{font-size:16px;margin:0 0 8px;color:var(--muted)}
  .grid{display:grid;gap:16px}
  @media(min-width:900px){.grid-2{grid-template-columns:1fr 1fr}.grid-3{grid-template-columns:1fr 1fr 1fr}}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--line);padding:10px;text-align:left;font-size:14.5px}
  th{color:var(--muted);font-weight:600}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .muted{color:var(--muted)}
  .list{display:flex;flex-direction:column;gap:8px;max-height:360px;overflow:auto}
  .pill{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--line);padding:10px;border-radius:12px;background:#fff}
  .checkbox{transform:scale(1.08)}
  footer{padding:20px;color:var(--muted)}
  @media(max-width:380px){
    .bar{padding:10px}
    .brand{gap:8px;font-size:16px}
    nav.tabs button{padding:8px 10px}
    .card{padding:12px}
    .btn,select,input{padding:10px 12px}
  }
  @media(min-width:1600px){
    h1{font-size:26px}
    .brand{font-size:20px}
  }
  .fade-in{opacity:0;transform:translateY(6px);animation:fade .45s ease forwards}
  @keyframes fade{to{opacity:1;transform:none}}
  .hidden{display:none !important}
  .admin-only.hidden{display:none !important}
  /* clean select arrow */
  select{
    appearance:none;-webkit-appearance:none;-moz-appearance:none;
    background-image:
      linear-gradient(45deg, transparent 50%, #6b7280 50%),
      linear-gradient(135deg, #6b7280 50%, transparent 50%),
      linear-gradient(to right, transparent, transparent);
    background-position:
      calc(100% - 20px) calc(1.1em),
      calc(100% - 15px) calc(1.1em),
      100% 0;
    background-size:5px 5px,5px 5px,2.5em 2.5em;
    background-repeat:no-repeat;
    padding-right:2.4em;
  }
  </style>
</head>
<body>
<header class="fade-in">
  <div class="bar">
    <div class="brand"><span class="dot"></span><span>trackME</span><small>copyright simon dass</small></div>
    <div class="spacer"></div>
    <button id="signOutBtn" class="btn ghost">Sign out</button>
  </div>
</header>

<main class="wrap fade-in">
  <nav class="tabs">
    <button data-tab="students" class="active">Students</button>
    <button data-tab="assign">Assign</button>
    <button data-tab="subjects">Subjects</button>
    <button data-tab="marking">Marking</button>
    <button data-tab="progress">View Progress</button>
    <button data-tab="data">Data</button>
  </nav>

  <section id="tab-students" class="tab card">
    <h2>Students</h2>
    <div class="grid grid-2">
      <div class="card">
        <h3>Add student</h3>
        <div class="row">
          <input id="studentName" type="text" placeholder="Full name" />
          <input id="studentPref" type="text" placeholder="Preferred name (optional)" />
          <button id="addStudentBtn" class="btn primary">Add</button>
        </div>
      </div>
      <div class="card">
        <h3>Students</h3>
        <div id="studentsList" class="list"></div>
      </div>
    </div>
  </section>

  <section id="tab-assign" class="tab card hidden">
    <h2>Assign students to subjects</h2>
    <div class="grid grid-2">
      <div class="card">
        <div class="row">
          <select id="assignStudentSel"></select>
          <button id="refreshAssignBtn" class="btn ghost">Refresh</button>
        </div>
        <div id="assignSubjects" class="list" style="margin-top:8px"></div>
        <div class="row" style="margin-top:8px">
          <button id="saveAssignBtn" class="btn primary">Save assignments</button>
        </div>
      </div>
      <div class="card">
        <h3>Notes</h3>
        <p class="muted">Subjects come from the global catalog.</p>
      </div>
    </div>
  </section>

  <section id="tab-subjects" class="tab card hidden">
    <div class="grid grid-2">
      <div class="card">
        <h2>Subject catalog</h2>
        <div class="row admin-only" id="adminAddSubject">
          <input id="subjectName" type="text" placeholder="New subject name" />
          <button id="addSubjectBtn" class="btn primary">Add</button>
        </div>
        <div id="subjectsList" class="list" style="margin-top:8px"></div>
        <p class="muted" id="subjectsInfo"></p>
      </div>
      <div class="card">
        <h2>Areas & key skills</h2>
        <div class="row">
          <select id="subjectSel"></select>
          <input id="areaName" class="admin-only" type="text" placeholder="New area of study" />
          <button id="addAreaBtn" class="btn ghost admin-only">Add area</button>
        </div>
        <div class="row" style="margin-top:8px">
          <select id="areaSel"></select>
          <input id="skillName" class="admin-only" type="text" placeholder="New key skill" />
          <button id="addSkillBtn" class="btn ghost admin-only">Add skill</button>
        </div>
        <div id="skillsList" class="list" style="margin-top:8px"></div>
      </div>
    </div>
  </section>

  <section id="tab-marking" class="tab card hidden">
    <h2>Marking</h2>
    <div class="row">
      <select id="mStudentSel"></select>
      <select id="mSubjectSel"></select>
      <select id="mAreaSel"></select>
    </div>
    <div id="markingTableWrap" class="card" style="margin-top:12px">
      <table id="markingTable">
        <thead><tr><th>Skill</th><th>Completed?</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section id="tab-progress" class="tab card hidden">
    <h2>View progress</h2>
    <div class="row">
      <select id="vStudentSel"></select>
      <select id="vSubjectSel"></select>
      <select id="vAreaSel"></select>
    </div>
    <div class="grid grid-2" style="margin-top:12px">
      <div class="card">
        <h3>Checklist</h3>
        <table id="viewTable">
          <thead><tr><th>Skill</th><th>Status</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="card">
        <h3>Overall completion</h3>
        <div class="row" style="align-items:center;gap:12px">
          <div style="width:10px;height:10px;border-radius:50%;background:var(--accent);box-shadow:0 0 0 8px rgba(0,150,136,.18)"></div>
          <div><span id="kpiPct">0%</span> complete</div>
        </div>
        <div class="card" style="margin-top:10px;background:#e8f6f5;border-color:#cfecea">
          <div class="progressbar" style="height:10px;background:#cfecea;border-radius:999px;overflow:hidden">
            <div id="kpiBar" style="height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-2));width:0;transition:width .35s"></div>
          </div>
          <p class="muted" style="margin-top:10px" id="kpiMeta">0 of 0 skills completed</p>
        </div>
      </div>
    </div>
  </section>

  <section id="tab-data" class="tab card hidden">
    <h2>Data</h2>
    <div class="row">
      <button id="exportBtn" class="btn ghost">Export JSON</button>
      <input id="importFile" type="file" accept="application/json" />
      <button id="importBtn" class="btn ghost admin-only">Import catalog JSON (admin)</button>
    </div>
    <p class="muted">Students & progress are private per account. Subjects come from a global catalog (read-only unless you're admin).</p>
  </section>
</main>

<footer class="wrap">
  <div class="muted">Â© trackME</div>
</footer>

<script type="module">
  // --- Replace with your Firebase config + admin identity ---
  const firebaseConfig = {
    apiKey: "AIzaSyDyVOcyN6GG4Eyk2bglXzZlpRAqE5h_J_8",
    authDomain: "tracker-project-3f3f5.firebaseapp.com",
    projectId: "tracker-project-3f3f5",
    appId: "1:997940286285:web:2e73d6113b74426acf5d04"
  };
  const ADMIN_EMAIL = "simon.dass.1996@gmail.com"; // set your admin email
  const ADMIN_UID = "agOwj4x61VNsOwJMmUz75hGiMw23"; // optional

  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
  import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
  import { getFirestore, doc, setDoc, getDoc, getDocs, addDoc, collection, deleteDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const $ = (id) => document.getElementById(id);
  const col = (...p) => collection(db, ...p);
  const ref = (...p) => doc(db, ...p);

  function el(tag, attrs = {}, ...kids) {
    const n = document.createElement(tag);
    for (const [k,v] of Object.entries(attrs)) {
      if (k==='class') n.className = v; else if(k==='html') n.innerHTML = v; else if(v!==undefined) n.setAttribute(k,v);
    }
    kids.forEach(k=> n.appendChild(typeof k==="string" ? document.createTextNode(k) : k));
    return n;
  }
  function showTab(name) {
    document.querySelectorAll('nav.tabs button').forEach(b => b.classList.toggle('active', b.dataset.tab===name));
    document.querySelectorAll('.tab').forEach(s => s.classList.add('hidden'));
    document.getElementById("tab-" + name).classList.remove('hidden');
  }
  function renderTabs() {
    document.querySelectorAll('nav.tabs button').forEach(btn => btn.addEventListener('click', () => showTab(btn.dataset.tab)));
    showTab('students');
  }
  document.getElementById("signOutBtn").onclick = async () => { await signOut(auth); window.location.href = "index.html"; };

  let state = { uid: null, isAdmin:false, students: [], subjects: [], areasBySubject: {}, skillsByArea: {}, enrolmentsByStudent: {} };

  onAuthStateChanged(auth, async (user) => {
    if (!user) { window.location.href = "index.html"; return; }
    state.uid = user.uid;
    state.isAdmin = (user.email === ADMIN_EMAIL) || (ADMIN_UID && user.uid === ADMIN_UID);
    document.querySelectorAll('.admin-only').forEach(elm => state.isAdmin ? elm.classList.remove('hidden') : elm.classList.add('hidden'));
    const info = document.getElementById("subjectsInfo");
    if (info) info.textContent = state.isAdmin ? "You are admin: you can create and edit the global catalog." : "Read-only: ask the admin to add or edit subject data.";

    await Promise.all([loadStudents(), loadCatalog()]);
    renderTabs();
    renderStudents();
    renderAssign();
    renderSubjects();
    renderAreasAndSkills();
    renderMarkingSelectors();
    renderViewSelectors();
  });

  /* Students */
  async function loadStudents() {
    const snap = await getDocs(col('users', state.uid, 'students'));
    state.students = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b)=> (a.name||'').localeCompare(b.name||''));
  }
  function renderStudents() {
    const list = document.getElementById("studentsList"); list.innerHTML = "";
    if (!state.students.length) list.append(el('div', {class:'muted'}, 'No students yet.'));
    for (const s of state.students) {
      const row = el('div', {class:'pill'},
        el('div',{}, s.name + (s.preferredName?`  Â· â${s.preferredName}â`:"")),
        el('div',{}, el('button', {class:'btn ghost', 'data-id': s.id}, 'Delete'))
      );
      row.querySelector('button').onclick = async () => {
        if (!confirm('Delete this student?')) return;
        await deleteDoc(ref('users', state.uid, 'students', s.id));
        await loadStudents(); renderStudents(); renderAssign(); renderMarkingSelectors(); renderViewSelectors();
      };
      list.append(row);
    }
  }
  document.getElementById("addStudentBtn").onclick = async () => {
    const name = document.getElementById("studentName").value.trim();
    if (!name) return;
    const preferred = document.getElementById("studentPref").value.trim();
    await addDoc(col('users', state.uid, 'students'), { name, preferredName: preferred||null, createdAt: serverTimestamp() });
    document.getElementById("studentName").value = ''; document.getElementById("studentPref").value='';
    await loadStudents(); renderStudents(); renderAssign(); renderMarkingSelectors(); renderViewSelectors();
  };

  /* Global Catalog */
  async function loadCatalog() {
    const subjectsSnap = await getDocs(col('catalog', 'global', 'subjects'));
    state.subjects = subjectsSnap.docs.map(d=>({ id:d.id, ...d.data() })).sort((a,b)=>(a.name||'').localeCompare(b.name||''));
    state.areasBySubject = {}; state.skillsByArea = {};
    for (const subj of state.subjects) {
      const areasSnap = await getDocs(col('catalog', 'global', 'subjects', subj.id, 'areas'));
      const areas = areasSnap.docs.map(d=>({ id:d.id, ...d.data() })).sort((a,b)=>(a.name||'').localeCompare(b.name||''));
      state.areasBySubject[subj.id] = areas;
      for (const a of areas) {
        const skillsSnap = await getDocs(col('catalog', 'global', 'subjects', subj.id, 'areas', a.id, 'skills'));
        const skills = skillsSnap.docs.map(d=>({ id:d.id, ...d.data() })).sort((x,y)=>(x.order??999)-(y.order??999));
        state.skillsByArea[a.id] = skills;
      }
    }
  }
  async function adminAddSubject(name) { if (!state.isAdmin) return alert('Admin only'); return await addDoc(col('catalog', 'global', 'subjects'), { name, createdAt: serverTimestamp() }); }
  async function adminDelSubject(id) { if (!state.isAdmin) return alert('Admin only'); await deleteDoc(ref('catalog', 'global', 'subjects', id)); }
  async function adminAddArea(subjectId, name) { if (!state.isAdmin) return alert('Admin only'); return await addDoc(col('catalog', 'global', 'subjects', subjectId, 'areas'), { name }); }
  async function adminAddSkill(subjectId, areaId, name, order) { if (!state.isAdmin) return alert('Admin only'); return await addDoc(col('catalog', 'global', 'subjects', subjectId, 'areas', areaId, 'skills'), { name, order }); }
  async function adminDelSkill(subjectId, areaId, skillId) { if (!state.isAdmin) return alert('Admin only'); await deleteDoc(ref('catalog', 'global', 'subjects', subjectId, 'areas', areaId, 'skills', skillId)); }

  function renderSubjects() {
    const list = document.getElementById("subjectsList"); list.innerHTML = "";
    if (!state.subjects.length) { list.append(el('div', {class:'muted'}, state.isAdmin ? 'No subjects yet â add one above.' : 'No subjects in catalog yet.')); return; }
    for (const s of state.subjects) {
      const row = el('div', {class:'pill'},
        el('div',{}, s.name),
        el('div',{}, ...(state.isAdmin ? [el('button', {class:'btn ghost', 'data-id': s.id}, 'Delete')] : []))
      );
      if (state.isAdmin) {
        row.querySelector('button').onclick = async () => {
          if (!confirm('Delete this subject (and its areas/skills)?')) return;
          await adminDelSubject(s.id);
          await loadCatalog(); renderSubjects(); renderAreasAndSkills(); renderAssign(); renderMarkingSelectors(); renderViewSelectors();
        };
      }
      list.append(row);
    }
  }

  function getSelections() { return { subjectId: document.getElementById("subjectSel").value || null, areaId: document.getElementById("areaSel").value || null }; }
  function restoreSelections(sel) {
    const subjSel = document.getElementById("subjectSel"), areaSel = document.getElementById("areaSel");
    if (sel.subjectId) { const opt = [...subjSel.options].find(o=>o.value===sel.subjectId); if (opt) subjSel.value = sel.subjectId; }
    subjSel.dispatchEvent(new Event('change'));
    if (sel.areaId) { const opt2 = [...areaSel.options].find(o=>o.value===sel.areaId); if (opt2) areaSel.value = sel.areaId; }
    areaSel.dispatchEvent(new Event('change'));
  }
  const subjectSel = document.getElementById("subjectSel"), areaSel = document.getElementById("areaSel"), skillsList = document.getElementById("skillsList");
  function renderAreasAndSkills() {
    const prev = getSelections();
    subjectSel.innerHTML = state.subjects.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
    if (state.subjects.length) { subjectSel.dispatchEvent(new Event('change')); restoreSelections(prev); }
    else { areaSel.innerHTML=""; skillsList.innerHTML=""; }
  }
  subjectSel.onchange = () => {
    const sid = subjectSel.value;
    const areas = state.areasBySubject[sid] || [];
    areaSel.innerHTML = areas.map(a=>`<option value="${a.id}">${a.name}</option>`).join('');
    areaSel.dispatchEvent(new Event('change'));
  };
  areaSel.onchange = () => {
    const aid = areaSel.value;
    const skills = state.skillsByArea[aid] || [];
    renderSkillList(skills);
  };
  function renderSkillList(skills) {
    skillsList.innerHTML = "";
    if (!skills.length) return skillsList.append(el('div', {class:'muted'}, 'No skills yet.'));
    for (const sk of skills) {
      const row = el('div', {class:'pill'},
        el('div',{}, (sk.order!=null?`#${sk.order} Â· `:"")+sk.name),
        el('div',{}, ...(state.isAdmin ? [el('button', {class:'btn ghost', 'data-id': sk.id}, 'Delete')] : []))
      );
      if (state.isAdmin) {
        row.querySelector('button').onclick = async () => {
          if (!confirm('Delete this skill?')) return;
          await adminDelSkill(subjectSel.value, areaSel.value, sk.id);
          await loadCatalog(); renderAreasAndSkills();
        };
      }
      skillsList.append(row);
    }
  }
  document.getElementById("addSubjectBtn").onclick = async () => {
    if (!state.isAdmin) return;
    const name = document.getElementById("subjectName").value.trim();
    if (!name) return;
    const docRef = await adminAddSubject(name);
    document.getElementById("subjectName").value='';
    await loadCatalog(); renderSubjects(); renderAreasAndSkills(); renderAssign(); renderMarkingSelectors(); renderViewSelectors();
    if (docRef?.id) { subjectSel.value = docRef.id; subjectSel.dispatchEvent(new Event('change')); }
  };
  document.getElementById("addAreaBtn").onclick = async () => {
    if (!state.isAdmin) return;
    const sid = subjectSel.value;
    const name = document.getElementById("areaName").value.trim();
    if (!sid || !name) return;
    const aRef = await adminAddArea(sid, name);
    document.getElementById("areaName").value='';
    await loadCatalog(); renderAreasAndSkills();
    subjectSel.value = sid; subjectSel.dispatchEvent(new Event('change'));
    if (aRef?.id) { areaSel.value = aRef.id; areaSel.dispatchEvent(new Event('change')); }
  };
  document.getElementById("addSkillBtn").onclick = async () => {
    if (!state.isAdmin) return;
    const sid = subjectSel.value, aid = areaSel.value;
    const name = document.getElementById("skillName").value.trim();
    if (!sid || !aid || !name) return;
    const order = (state.skillsByArea[aid]?.length || 0) + 1;
    await adminAddSkill(sid, aid, name, order);
    document.getElementById("skillName").value='';
    await loadCatalog(); renderAreasAndSkills();
    subjectSel.value = sid; subjectSel.dispatchEvent(new Event('change'));
    areaSel.value = aid; areaSel.dispatchEvent(new Event('change'));
  };

  /* Assign */
  const assignStudentSel = document.getElementById("assignStudentSel");
  function renderAssign() {
    assignStudentSel.innerHTML = state.students.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
    assignStudentSel.dispatchEvent(new Event('change'));
  }
  document.getElementById("refreshAssignBtn").onclick = async () => { await loadEnrolments(assignStudentSel.value); renderAssignSubjects(assignStudentSel.value); };
  assignStudentSel.onchange = async () => { await loadEnrolments(assignStudentSel.value); renderAssignSubjects(assignStudentSel.value); };

  async function loadEnrolments(studentId) {
    if (!studentId) return;
    const snap = await getDocs(col('users', state.uid, 'students', studentId, 'subjects'));
    const enrols = new Set(snap.docs.map(d=>d.id));
    state.enrolmentsByStudent[studentId] = enrols;
  }
  function renderAssignSubjects(studentId) {
    const box = document.getElementById("assignSubjects"); box.innerHTML="";
    const enrols = state.enrolmentsByStudent[studentId] || new Set();
    for (const subj of state.subjects) {
      const row = document.createElement('label'); row.className='pill';
      const name = document.createElement('div'); name.textContent=subj.name;
      const cb = document.createElement('input'); cb.type='checkbox'; cb.className='checkbox'; cb.setAttribute('data-id', subj.id);
      cb.checked = enrols.has(subj.id);
      row.appendChild(name); row.appendChild(cb); box.appendChild(row);
    }
  }
  document.getElementById("saveAssignBtn").onclick = async () => {
    const studentId = assignStudentSel.value;
    if (!studentId) return;
    const checks = Array.from(document.querySelectorAll('#assignSubjects input[type="checkbox"]'));
    const selected = checks.filter(c=>c.checked).map(c=>c.getAttribute('data-id'));
    const existing = state.enrolmentsByStudent[studentId] || new Set();
    for (const sid of Array.from(existing)) {
      if (!selected.includes(sid)) await deleteDoc(ref('users', state.uid, 'students', studentId, 'subjects', sid));
    }
    for (const sid of selected) {
      await setDoc(ref('users', state.uid, 'students', studentId, 'subjects', sid), { enrolled: true, updatedAt: serverTimestamp() });
    }
    await loadEnrolments(studentId);
    renderAssignSubjects(studentId);
  };

  /* Marking */
  const mStudentSel = document.getElementById("mStudentSel"), mSubjectSel = document.getElementById("mSubjectSel"), mAreaSel = document.getElementById("mAreaSel");
  function renderMarkingSelectors() {
    mStudentSel.innerHTML = state.students.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
    mStudentSel.dispatchEvent(new Event('change'));
  }
  mStudentSel.onchange = async () => {
    const sid = mStudentSel.value;
    await loadEnrolments(sid);
    const enrols = state.enrolmentsByStudent[sid] || new Set();
    const subjects = state.subjects.filter(s=> enrols.has(s.id));
    mSubjectSel.innerHTML = subjects.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
    mSubjectSel.dispatchEvent(new Event('change'));
  };
  mSubjectSel.onchange = () => {
    const subjId = mSubjectSel.value;
    const areas = state.areasBySubject[subjId] || [];
    mAreaSel.innerHTML = areas.map(a=>`<option value="${a.id}">${a.name}</option>`).join('');
    mAreaSel.dispatchEvent(new Event('change'));
  };
  mAreaSel.onchange = async () => { await renderMarkingTable(); };

  async function renderMarkingTable() {
    const studentId = mStudentSel.value;
    const subjectId = mSubjectSel.value;
    const areaId = mAreaSel.value;
    const tbody = document.querySelector('#markingTable tbody');
    tbody.innerHTML = "";
    const skills = state.skillsByArea[areaId] || [];
    if (!skills.length) return tbody.append(el('tr',{}, el('td',{colspan:'2'}, 'No skills for this area.')));

    for (const sk of skills) {
      const pRef = ref('users', state.uid, 'progress', studentId, 'subjects', subjectId, 'skills', sk.id);
      const snap = await getDoc(pRef);
      const completed = !!(snap.exists() && snap.data().completed);
      const tr = el('tr',{}, el('td',{}, sk.name), el('td',{}, (()=>{ 
        const cb = el('input', {type:'checkbox', class:'checkbox'});
        cb.checked = completed;
        cb.onchange = async () => {
          await setDoc(pRef, { completed: cb.checked, updatedAt: serverTimestamp() }, { merge: true });
          if (document.getElementById("vStudentSel").value===studentId && document.getElementById("vSubjectSel").value===subjectId && document.getElementById("vAreaSel").value===areaId) { await renderViewTable(); }
        };
        return cb;
      })()));
      tbody.append(tr);
    }
  }

  /* View Progress */
  const vStudentSel = document.getElementById("vStudentSel"), vSubjectSel = document.getElementById("vSubjectSel"), vAreaSel = document.getElementById("vAreaSel");
  function renderViewSelectors() {
    vStudentSel.innerHTML = state.students.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
    vStudentSel.dispatchEvent(new Event('change'));
  }
  vStudentSel.onchange = async () => {
    const sid = vStudentSel.value;
    await loadEnrolments(sid);
    const enrols = state.enrolmentsByStudent[sid] || new Set();
    const subjects = state.subjects.filter(s=> enrols.has(s.id));
    vSubjectSel.innerHTML = subjects.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
    vSubjectSel.dispatchEvent(new Event('change'));
  };
  vSubjectSel.onchange = () => {
    const subjId = vSubjectSel.value;
    const areas = state.areasBySubject[subjId] || [];
    vAreaSel.innerHTML = areas.map(a=>`<option value="${a.id}">${a.name}</option>`).join('');
    vAreaSel.dispatchEvent(new Event('change'));
  };
  vAreaSel.onchange = async () => { await renderViewTable(); };

  async function renderViewTable() {
    const studentId = vStudentSel.value;
    const subjectId = vSubjectSel.value;
    const areaId = vAreaSel.value;
    const tbody = document.querySelector('#viewTable tbody');
    const bar = document.getElementById('kpiBar'), pct = document.getElementById('kpiPct'), meta = document.getElementById('kpiMeta');
    tbody.innerHTML = "";
    const skills = state.skillsByArea[areaId] || [];
    if (!skills.length) {
      tbody.append(el('tr',{}, el('td',{colspan:'2'}, 'No skills for this area.')));
      bar.style.width = '0%'; pct.textContent = '0%'; meta.textContent = '0 of 0 skills completed';
      return;
    }
    let done = 0;
    for (const sk of skills) {
      const pRef = ref('users', state.uid, 'progress', studentId, 'subjects', subjectId, 'skills', sk.id);
      const snap = await getDoc(pRef);
      const completed = !!(snap.exists() && snap.data().completed);
      if (completed) done++;
      const tr = el('tr',{}, el('td',{}, sk.name), el('td',{}, completed ? 'â Completed' : 'â'));
      tbody.append(tr);
    }
    const total = skills.length;
    const pctNum = Math.round((done/total)*100);
    bar.style.width = pctNum + '%';
    pct.textContent = pctNum + '%';
    meta.textContent = `${done} of ${total} skills completed`;
  }
</script>
</body>
</html>
