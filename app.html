<!DOCTYPE html>
<html lang="en-AU">
<head>
  <title>trackME</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="icon" href="logo.svg">
  <style>
  :root{
    --bg:#ffffff; --surface:#ffffff; --ink:#0a0a0a; --muted:#6b7280; --line:#e5e7eb;
    --accent:#111111; --accent-2:#000000; --highlight:#ffd54a; --danger:#e11d48;
    --radius:14px; --shadow:0 10px 34px rgba(0,0,0,.08);
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);
    font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
  .btn,select,input[type="text"],input[type="email"],input[type="password"]{
    border:1px solid var(--line);border-radius:10px;background:#fff;color:var(--ink);font:inherit;outline:none;
    transition:box-shadow .18s ease, transform .14s ease, background-color .18s ease, border-color .18s}
  .btn{cursor:pointer}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  .btn.primary:hover{background:var(--accent-2);transform:translateY(-1px)}
  .btn.ghost{background:#fff;color:var(--ink)} .btn.ghost:hover{background:#f7f7f7}
  .control-lg{padding:12px 14px} .control-sm{padding:9px 12px;font-size:14px;border-radius:8px}
  .btn-sm{padding:8px 12px;font-size:14px;border-radius:8px} .btn-lg{padding:12px 16px}
  select:hover,input:hover{background:#fafafa}
  select:focus,input:focus,.btn:focus{box-shadow:0 0 0 3px rgba(255,213,74,.45);border-color:var(--accent)}
  .wrap{width:100%;max-width:min(1200px,94vw);margin:0 auto;padding:clamp(8px,2vw,20px)}
  .card{background:var(--surface);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
  .brand{display:flex;align-items:center;gap:10px;font-weight:700;font-size:18px;letter-spacing:.2px}
  .logo{width:22px;height:22px;display:inline-block}
  .brand small{font-weight:600;color:var(--muted);font-size:12px}
  .spacer{flex:1}
  header{position:sticky;top:0;z-index:20;background:rgba(255,255,255,.86);
    backdrop-filter:saturate(140%) blur(10px);border-bottom:1px solid var(--line)}
  .bar{display:flex;align-items:center;gap:14px;padding:12px 16px}
  h2{font-size:18px;margin:0 0 8px;color:var(--accent)}
  h3{font-size:15px;margin:0 0 8px;color:var(--muted);font-weight:600}
  nav.tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 16px}
  nav.tabs button{padding:8px 12px;border-radius:10px;border:1px solid var(--line);background:#fff;color:var(--ink);font-weight:600}
  nav.tabs button.active{color:#fff;background:var(--accent);border-color:var(--accent)}
  nav.tabs button:focus{outline:none;box-shadow:0 0 0 3px rgba(255,213,74,.45)}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--line);padding:10px 8px;text-align:left;font-size:14.5px}
  th{color:var(--muted);font-weight:700;letter-spacing:.2px}
  .list{display:flex;flex-direction:column;gap:8px;max-height:380px;overflow:auto}
  .pill{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--line);padding:8px 10px;border-radius:10px;background:#fff}
  .toolbar{display:grid;gap:8px}
  .toolbar.cols-3{grid-template-columns:repeat(auto-fit,minmax(140px,1fr))}
  .toolbar.cols-2{grid-template-columns:repeat(auto-fit,minmax(160px,1fr))}
  .toolbar select,.toolbar input,.toolbar .btn{width:100%;max-width:260px;justify-self:start}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .row.compact > *{flex:0 0 auto;max-width:260px}
  @media(max-width:420px){.card{padding:14px}.toolbar select,.toolbar input,.toolbar .btn{max-width:100%}}
  .progressbar{height:12px;background:#f1f1f1;border-radius:999px;overflow:hidden;border:1px solid var(--line)}
  #kpiBar{height:100%;background:linear-gradient(90deg,var(--highlight),#ffb300);width:0;transition:width .35s}
  select{appearance:none;-webkit-appearance:none;-moz-appearance:none;
    background-image:
      linear-gradient(45deg, transparent 50%, #6b7280 50%),
      linear-gradient(135deg, #6b7280 50%, transparent 50%),
      linear-gradient(to right, transparent, transparent);
    background-position:
      calc(100% - 20px) calc(1.05em),
      calc(100% - 15px) calc(1.05em),
      100% 0;
    background-size:5px 5px,5px 5px,2.5em 2.5em;
    background-repeat:no-repeat;
    padding-right:2.4em}
  .fade-in{opacity:0;transform:translateY(6px);animation:fade .45s ease forwards}
  @keyframes fade{to{opacity:1;transform:none}}
  .hidden{display:none !important}
  .admin-only.hidden{display:none !important}
  </style>
  <svg style="position:absolute;width:0;height:0;overflow:hidden" aria-hidden="true">
    <symbol id="logo-trackme" viewBox="0 0 64 64">
      <rect x="6" y="6" width="52" height="52" rx="12" fill="none" stroke="#111" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M20 34 l8 8 l16 -20" fill="none" stroke="#111" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
      <circle cx="50" cy="14" r="5" fill="#ffd54a"/>
    </symbol>
  </svg>

</head>
<body>
<header class="fade-in">
  <div class="bar">
    <div class="brand"><svg class="logo"><use href="#logo-trackme"/></svg><span>trackME</span><small></small></div>
    <div class="spacer"></div>
    <button id="signOutBtn" class="btn btn-sm ghost">Sign out</button>
  </div>
</header>

<main class="wrap fade-in">
  <nav class="tabs">
    <button data-tab="students" class="active">Students</button>
    <button data-tab="assign">Assign</button>
    <button data-tab="subjects">Subjects</button>
    <button data-tab="marking">Marking</button>
    <button data-tab="progress">View Progress</button>
    <button data-tab="data">Data</button>
  </nav>

  <section id="tab-students" class="tab card">
    <h2>Students</h2>
    <div class="grid grid-2" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px">
      <div class="card">
        <h3>Add student</h3>
        <div class="row compact">
          <input id="studentName" class="control-sm" type="text" placeholder="Full name" />
          <input id="studentPref" class="control-sm" type="text" placeholder="Preferred name (optional)" />
          <button id="addStudentBtn" class="btn btn-sm primary">Add</button>
        </div>
      </div>
      <div class="card">
        <h3>Students</h3>
        <div id="studentsList" class="list"></div>
      </div>
    </div>
  </section>

  <section id="tab-assign" class="tab card hidden">
    <h2>Assign students to subjects</h2>
    <div class="grid grid-2" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px">
      <div class="card">
        <div class="toolbar cols-2">
          <select id="assignStudentSel" class="control-sm"></select>
          <button id="refreshAssignBtn" class="btn btn-sm ghost">Refresh</button>
        </div>
        <div id="assignSubjects" class="list" style="margin-top:8px"></div>
        <div class="row" style="margin-top:8px">
          <button id="saveAssignBtn" class="btn btn-sm primary">Save assignments</button>
        </div>
      </div>
      <div class="card">
        <h3>Notes</h3>
        <p class="muted">Subjects come from the global catalog.</p>
      </div>
    </div>
  </section>

  <section id="tab-subjects" class="tab card hidden">
    <div class="grid grid-2" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px">
      <div class="card">
        <h2>Subject catalog</h2>
        <div class="row compact admin-only" id="adminAddSubject">
          <input id="subjectName" class="control-sm" type="text" placeholder="New subject name" />
          <button id="addSubjectBtn" class="btn btn-sm primary">Add</button>
        </div>
        <div id="subjectsList" class="list" style="margin-top:8px"></div>
        <p class="muted" id="subjectsInfo"></p>
      </div>
      <div class="card">
        <h2>Areas & key skills</h2>
        <div class="toolbar cols-3">
          <select id="subjectSel" class="control-sm"></select>
          <input id="areaName" class="control-sm admin-only" type="text" placeholder="New area of study" />
          <button id="addAreaBtn" class="btn btn-sm ghost admin-only">Add area</button>
        </div>
        <div class="toolbar cols-3" style="margin-top:8px">
          <select id="areaSel" class="control-sm"></select>
          <input id="skillName" class="control-sm admin-only" type="text" placeholder="New key skill" />
          <button id="addSkillBtn" class="btn btn-sm ghost admin-only">Add skill</button>
        </div>
        <div id="skillsList" class="list" style="margin-top:8px"></div>
      </div>
    </div>
  </section>

  <section id="tab-marking" class="tab card hidden">
    <h2>Marking</h2>
    <div class="toolbar cols-3">
      <select id="mStudentSel" class="control-sm"></select>
      <select id="mSubjectSel" class="control-sm"></select>
      <select id="mAreaSel" class="control-sm"></select>
    </div>
    <div id="markingTableWrap" class="card" style="margin-top:12px">
      <table id="markingTable">
        <thead><tr><th>Skill</th><th style="width:120px">Completed?</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section id="tab-progress" class="tab card hidden">
    <h2>View progress</h2>
    <div class="toolbar cols-3">
      <select id="vStudentSel" class="control-sm"></select>
      <select id="vSubjectSel" class="control-sm"></select>
      <select id="vAreaSel" class="control-sm"></select>
    </div>
    <div class="grid grid-2" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;margin-top:12px">
      <div class="card">
        <h3>Checklist</h3>
        <table id="viewTable">
          <thead><tr><th>Skill</th><th style="width:130px">Status</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="card">
        <h3>Overall completion</h3>
        <div class="row" style="align-items:center;gap:10px">
          <svg class="logo"><use href="#logo-trackme"/></svg>
          <div><span id="kpiPct">0%</span> complete</div>
        </div>
        <div class="card" style="margin-top:10px;background:#fff;border-color:var(--line)">
          <div class="progressbar">
            <div id="kpiBar"></div>
          </div>
          <p class="muted" style="margin-top:10px" id="kpiMeta">0 of 0 skills completed</p>
        </div>
      </div>
    </div>
  </section>

  <section id="tab-data" class="tab card hidden">
    <h2>Data</h2>
    <div class="row compact">
      <button id="exportBtn" class="btn btn-sm ghost">Export JSON</button>
      <input id="importFile" class="control-sm" type="file" accept="application/json" />
      <button id="importBtn" class="btn btn-sm ghost admin-only">Import catalog JSON (admin)</button>
    </div>
    <p class="muted">Students & progress are private per account. Subjects come from a global catalog (read-only unless you're admin).</p>
  </section>
</main>

<footer class="wrap">
  <div class="muted">© Simon Dass</div>
</footer>

<script type="module">
  const firebaseConfig = {
    // Your config details are fine, but it's good practice to keep them secure
    apiKey: "AIzaSyDyVOcyN6GG4Eyk2bglXzZlpRAqE5h_J_8",
    authDomain: "tracker-project-3f3f5.firebaseapp.com",
    projectId: "tracker-project-3f3f5",
    appId: "1:997940286285:web:2e73d6113b74426acf5d04"
  };

  const ADMIN_EMAIL = "simon.dass.1996@gmail.com";
  const ADMIN_UID = "agOwj4x61VNsOwJMmUz75hGiMw23";

  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
  import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
  import { getFirestore, doc, setDoc, getDoc, getDocs, addDoc, collection, deleteDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const $ = (id) => document.getElementById(id);
  const col = (...p) => collection(db, ...p);
  const ref = (...p) => doc(db, ...p);

  function el(tag, attrs = {}, ...kids) {
    const n = document.createElement(tag);
    for (const [k,v] of Object.entries(attrs)) {
      if (k==='class') n.className = v; else if(k==='html') n.innerHTML = v; else if(v!==undefined) n.setAttribute(k,v);
    }
    kids.forEach(k=> n.appendChild(typeof k==="string" ? document.createTextNode(k) : k));
    return n;
  }
  function showTab(name) {
    document.querySelectorAll('nav.tabs button').forEach(b => b.classList.toggle('active', b.dataset.tab===name));
    document.querySelectorAll('.tab').forEach(s => s.classList.add('hidden'));
    document.getElementById("tab-" + name).classList.remove('hidden');
  }
  function renderTabs() {
    document.querySelectorAll('nav.tabs button').forEach(btn => btn.addEventListener('click', () => showTab(btn.dataset.tab)));
    showTab('students');
  }
  $("signOutBtn").onclick = async () => { await signOut(auth); window.location.href = "index.html"; };

  let state = { uid: null, isAdmin:false, students: [], subjects: [], enrolmentsByStudent: {} };

  onAuthStateChanged(auth, async (user) => {
    if (!user) { window.location.href = "index.html"; return; }
    state.uid = user.uid;
    state.isAdmin = (user.email === ADMIN_EMAIL) || (ADMIN_UID && user.uid === ADMIN_UID);
    document.querySelectorAll('.admin-only').forEach(elm => state.isAdmin ? elm.classList.remove('hidden') : elm.classList.add('hidden'));
    const info = $("subjectsInfo");
    if (info) info.textContent = state.isAdmin ? "You are admin: you can create and edit the global catalog." : "Read-only: ask the admin to add or edit subject data.";

    // --- MODIFICATION: Load data sequentially and populate UI as we go ---
    renderTabs();
    await loadStudents();
    await loadSubjects();
    populateAllStudentDropdowns(); // New function to update all selectors at once
    populateAssignSubjects();
    populateSubjectDropdowns();
  });

  async function loadStudents() {
    const snap = await getDocs(col('users', state.uid, 'students'));
    state.students = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b)=> (a.name||'').localeCompare(b.name||''));
    renderStudentsList();
  }
  function renderStudentsList() {
    const list = $("studentsList"); list.innerHTML = "";
    if (!state.students.length) list.append(el('div', {class:'muted'}, 'No students yet.'));
    for (const s of state.students) {
      const row = el('div', {class:'pill'},
        el('div',{}, s.name + (s.preferredName?`  · “${s.preferredName}”`:"")),
        el('div',{}, el('button', {class:'btn btn-sm ghost','data-id': s.id}, 'Delete'))
      );
      row.querySelector('button').onclick = async () => {
        if (!confirm('Delete this student?')) return;
        await deleteDoc(ref('users', state.uid, 'students', s.id));
        await loadStudents();
        populateAllStudentDropdowns();
      };
      list.append(row);
    }
  }
  $("addStudentBtn").onclick = async () => {
    const name = $("studentName").value.trim();
    if (!name) return;
    const preferred = $("studentPref").value.trim();
    await addDoc(col('users', state.uid, 'students'), { name, preferredName: preferred||null, createdAt: serverTimestamp() });
    $("studentName").value = ''; $("studentPref").value='';
    await loadStudents();
    populateAllStudentDropdowns();
  };

  async function loadSubjects() {
      const snap = await getDocs(col('catalog', 'global', 'subjects'));
      state.subjects = snap.docs.map(d=>({ id:d.id, ...d.data() })).sort((a,b)=>(a.name||'').localeCompare(b.name||''));
      renderSubjectsList();
  }
  async function getAreasForSubject(subjectId) {
      const snap = await getDocs(col('catalog', 'global', 'subjects', subjectId, 'areas'));
      return snap.docs.map(d=>({ id:d.id, ...d.data() })).sort((a,b)=>(a.name||'').localeCompare(b.name||''));
  }
  async function getSkillsForArea(subjectId, areaId) {
      const snap = await getDocs(col('catalog', 'global', 'subjects', subjectId, 'areas', areaId, 'skills'));
      return snap.docs.map(d=>({ id:d.id, ...d.data() })).sort((x,y)=>(x.order??999)-(y.order??999));
  }
  async function loadEnrolments(studentId) {
    if (!studentId || state.enrolmentsByStudent[studentId]) return; // Don't re-fetch if already loaded
    const snap = await getDocs(col('users', state.uid, 'students', studentId, 'subjects'));
    state.enrolmentsByStudent[studentId] = new Set(snap.docs.map(d=>d.id));
  }
  
  // --- STUDENT DROPDOWNS ---
  function populateAllStudentDropdowns() {
    const studentOptions = state.students.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
    $("assignStudentSel").innerHTML = studentOptions;
    $("mStudentSel").innerHTML = studentOptions;
    $("vStudentSel").innerHTML = studentOptions;
    // Trigger change events to load dependent data
    $("assignStudentSel").dispatchEvent(new Event('change'));
    $("mStudentSel").dispatchEvent(new Event('change'));
    $("vStudentSel").dispatchEvent(new Event('change'));
  }

  // --- SUBJECTS TAB ---
  function renderSubjectsList() {
    const list = $("subjectsList"); list.innerHTML = "";
    if (!state.subjects.length) { list.append(el('div', {class:'muted'}, state.isAdmin ? 'No subjects yet — add one above.' : 'No subjects in catalog yet.')); return; }
    for (const s of state.subjects) {
      const row = el('div', {class:'pill'}, el('div',{}, s.name), el('div',{}, ...(state.isAdmin ? [el('button', {class:'btn btn-sm ghost','data-id': s.id}, 'Delete')] : [])));
      if (state.isAdmin) {
        row.querySelector('button').onclick = async () => {
          if (!confirm('Delete this subject (and its areas/skills)?')) return;
          await deleteDoc(ref('catalog', 'global', 'subjects', s.id)); // Note: Subcollections need manual deletion if complex
          await loadSubjects();
          populateSubjectDropdowns();
        };
      }
      list.append(row);
    }
  }
  $("addSubjectBtn").onclick = async () => {
    if (!state.isAdmin) return;
    const name = $("subjectName").value.trim();
    if (!name) return;
    await addDoc(col('catalog', 'global', 'subjects'), { name, createdAt: serverTimestamp() });
    $("subjectName").value='';
    await loadSubjects();
    populateSubjectDropdowns();
  };
  
  function populateSubjectDropdowns() {
    const subjectOptions = state.subjects.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
    $("subjectSel").innerHTML = subjectOptions;
    $("subjectSel").dispatchEvent(new Event('change'));
  }

  $("subjectSel").onchange = async () => {
      const subjectId = $("subjectSel").value;
      const areaSel = $("areaSel");
      areaSel.innerHTML = "<option>Loading areas...</option>";
      const areas = subjectId ? await getAreasForSubject(subjectId) : [];
      areaSel.innerHTML = areas.map(a=>`<option value="${a.id}">${a.name}</option>`).join('');
      areaSel.dispatchEvent(new Event('change'));
  };
  $("areaSel").onchange = async () => {
      const subjectId = $("subjectSel").value;
      const areaId = $("areaSel").value;
      const list = $("skillsList");
      list.innerHTML = "Loading skills...";
      const skills = (subjectId && areaId) ? await getSkillsForArea(subjectId, areaId) : [];
      renderSkillList(list, skills, subjectId, areaId);
  };
  function renderSkillList(listElement, skills, subjectId, areaId) {
    listElement.innerHTML = "";
    if (!skills.length) return listElement.append(el('div', {class:'muted'}, 'No skills yet.'));
    for (const sk of skills) {
      const row = el('div', {class:'pill'}, el('div',{}, (sk.order!=null?`#${sk.order} · `:"")+sk.name), el('div',{}, ...(state.isAdmin ? [el('button', {class:'btn btn-sm ghost','data-id': sk.id}, 'Delete')] : [])));
      if (state.isAdmin) {
        row.querySelector('button').onclick = async () => {
          if (!confirm('Delete this skill?')) return;
          await deleteDoc(ref('catalog', 'global', 'subjects', subjectId, 'areas', areaId, 'skills', sk.id));
          $("areaSel").dispatchEvent(new Event('change')); // Refresh list
        };
      }
      listElement.append(row);
    }
  }
  // Add Area and Skill buttons logic here...

  // --- ASSIGN TAB ---
  $("assignStudentSel").onchange = async () => { populateAssignSubjects(); };
  $("refreshAssignBtn").onclick = async () => {
    state.enrolmentsByStudent[$("assignStudentSel").value] = null; // Force refresh
    populateAssignSubjects();
  };
  async function populateAssignSubjects() {
    const studentId = $("assignStudentSel").value;
    const box = $("assignSubjects");
    box.innerHTML="Loading...";
    if (!studentId) { box.innerHTML=""; return; }
    await loadEnrolments(studentId);
    const enrols = state.enrolmentsByStudent[studentId] || new Set();
    box.innerHTML="";
    for (const subj of state.subjects) {
      const row = el('label', {class:'pill'}, el('div',{}, subj.name), (()=>{ const cb=el('input',{type:'checkbox'}); cb.checked=enrols.has(subj.id); cb.setAttribute('data-id', subj.id); return cb; })());
      box.appendChild(row);
    }
  }
  $("saveAssignBtn").onclick = async () => {
    const studentId = $("assignStudentSel").value;
    if (!studentId) return;
    const checks = Array.from(document.querySelectorAll('#assignSubjects input[type="checkbox"]'));
    const selectedIds = new Set(checks.filter(c=>c.checked).map(c=>c.getAttribute('data-id')));
    const existingIds = state.enrolmentsByStudent[studentId] || new Set();
    const toAdd = [...selectedIds].filter(id => !existingIds.has(id));
    const toRemove = [...existingIds].filter(id => !selectedIds.has(id));
    
    for (const sid of toRemove) await deleteDoc(ref('users', state.uid, 'students', studentId, 'subjects', sid));
    for (const sid of toAdd) await setDoc(ref('users', state.uid, 'students', studentId, 'subjects', sid), { enrolled: true, updatedAt: serverTimestamp() });
    
    state.enrolmentsByStudent[studentId] = selectedIds; // Update local state
    alert('Assignments saved!');
  };

  // --- MARKING & VIEWING TABS (Generic handler) ---
  function createTabLogic(studentSelId, subjectSelId, areaSelId, renderFunction) {
      const studentSel = $(studentSelId);
      const subjectSel = $(subjectSelId);
      const areaSel = $(areaSelId);

      studentSel.onchange = async () => {
          const studentId = studentSel.value;
          subjectSel.innerHTML = "<option>Loading...</option>";
          if (!studentId) { subjectSel.innerHTML = ""; areaSel.innerHTML = ""; return; }
          await loadEnrolments(studentId);
          const enrols = state.enrolmentsByStudent[studentId] || new Set();
          const subjects = state.subjects.filter(s => enrols.has(s.id));
          subjectSel.innerHTML = subjects.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
          subjectSel.dispatchEvent(new Event('change'));
      };
      subjectSel.onchange = async () => {
          const subjectId = subjectSel.value;
          areaSel.innerHTML = "<option>Loading...</option>";
          if (!subjectId) { areaSel.innerHTML = ""; return; }
          const areas = await getAreasForSubject(subjectId);
          areaSel.innerHTML = areas.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
          areaSel.dispatchEvent(new Event('change'));
      };
      areaSel.onchange = renderFunction;
  }

  // --- MARKING TAB ---
  createTabLogic('mStudentSel', 'mSubjectSel', 'mAreaSel', renderMarkingTable);
  async function renderMarkingTable() {
    const studentId = $("mStudentSel").value, subjectId = $("mSubjectSel").value, areaId = $("mAreaSel").value;
    const tbody = $("markingTable").querySelector('tbody');
    tbody.innerHTML = "";
    if (!studentId || !subjectId || !areaId) return;
    
    const skills = await getSkillsForArea(subjectId, areaId);
    if (!skills.length) return tbody.append(el('tr',{}, el('td',{colspan:'2'}, 'No skills for this area.')));

    const progressSnap = await getDocs(col('users', state.uid, 'progress', studentId, 'subjects', subjectId, 'skills'));
    const completedSkills = new Set(progressSnap.docs.filter(d => d.data().completed).map(d => d.id));

    for (const sk of skills) {
      const cb = el('input', {type:'checkbox'});
      cb.checked = completedSkills.has(sk.id);
      cb.onchange = async () => {
        const pRef = ref('users', state.uid, 'progress', studentId, 'subjects', subjectId, 'skills', sk.id);
        await setDoc(pRef, { completed: cb.checked, updatedAt: serverTimestamp() }, { merge: true });
      };
      tbody.append(el('tr', {}, el('td', {}, sk.name), el('td', {}, cb)));
    }
  }

  // --- VIEW PROGRESS TAB ---
  createTabLogic('vStudentSel', 'vSubjectSel', 'vAreaSel', renderViewTable);
  async function renderViewTable() {
    const studentId = $("vStudentSel").value, subjectId = $("vSubjectSel").value, areaId = $("vAreaSel").value;
    const tbody = $("viewTable").querySelector('tbody');
    const bar = $("kpiBar"), pct = $("kpiPct"), meta = $("kpiMeta");
    tbody.innerHTML = "";
    bar.style.width = '0%'; pct.textContent = '0%'; meta.textContent = '0 of 0 skills completed';
    if (!studentId || !subjectId || !areaId) return;

    const skills = await getSkillsForArea(subjectId, areaId);
    if (!skills.length) return tbody.append(el('tr',{}, el('td',{colspan:'2'}, 'No skills.')));
    
    const progressSnap = await getDocs(col('users', state.uid, 'progress', studentId, 'subjects', subjectId, 'skills'));
    const completedSkills = new Set(progressSnap.docs.filter(d => d.data().completed).map(d => d.id));

    let done = 0;
    for (const sk of skills) {
      const completed = completedSkills.has(sk.id);
      if (completed) done++;
      tbody.append(el('tr', {}, el('td', {}, sk.name), el('td', {}, completed ? '✓ Completed' : '—')));
    }

    const total = skills.length;
    if (total > 0) {
      const pctNum = Math.round((done/total)*100);
      bar.style.width = pctNum + '%';
      pct.textContent = pctNum + '%';
      meta.textContent = `${done} of ${total} skills completed`;
    }
  }
</script>
</body>
</html>
